on: [push]

permissions:
  contents: write

name: CI

jobs:
  build_test_and_archive:
    name: build_test_and_archive
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Nix
        uses: cachix/install-nix-action@v17
        with:
          # Mostly to avoid GitHub rate limiting
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: build original wasm, build and test typescript integration
        run: nix develop --command bash -c "rustup default stable && make build && cd typescript_integration && npm install && npm run build && npm run awesometest"
      - name: base64 encode musig_banano_wasm
        run: nix develop --command bash -c "wasm-strip target/wasm32-unknown-unknown/release/musig_banano_wasm.wasm && (cat target/wasm32-unknown-unknown/release/musig_banano_wasm.wasm | base64) > gh-pages/musig_banano_wasm.wasm.b64"
      - name: create index.html for gh-pages from template
        run: cd gh-pages && sed '/<script type="data" id="wasmBase64">/r musig_banano_wasm.wasm.b64' index.html.template > index.html
      - name: Deploy templated gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      - name: Deploy mochawesome report page
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: typescript_integration/mochawesome-report
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          keep_files: true
      - name: archive original rust wasm
        uses: actions/upload-artifact@v3
        with:
          name: musig_banano_wasm.wasm
          path: |
            target/wasm32-unknown-unknown/release/musig_banano_wasm.wasm
      - name: archive typescript pkg directory
        uses: actions/upload-artifact@v3
        with:
          name: typescript_integration_pkg_directory
          path: |
            pkg/
      - name: release orignal rust wasm
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: target/wasm32-unknown-unknown/release/musig_banano_wasm.wasm
      - name: release dist dir
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: pkg/**
  
